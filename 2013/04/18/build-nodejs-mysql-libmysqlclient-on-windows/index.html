<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>nodejs mysql-libmysqlclient on windows - tengattack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="generator" content="hanejs" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="alternate" href="/atom.xml" type="application/atom+xml" title="tengattack ATOM Feed" />
  <link rel="search" href="http://blog.tengattack.com/atom.xml" type="application/opensearchdescription+xml" title="tengattack" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
</head>
<body>
  <div class="site">
    <div class="site-inner">
      <header class="site-header">
        <div class="site-header-main">
          <div class="site-branding">
            <a href="/" title="tengattack">
              <h1 class="site-title">tengattack</h1>
            </a>
          </div>
          <div class="site-tabs">
            <ul class="site-tab-nav">
              <li class="active"><a href="/" title="Blog">Blog</a></li>
              <li><a href="/about/" title="关于">关于</a></li>
              <li><a href="/projects/" title="我的项目">我的项目</a></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="site-content">
        <div class="content-area">
          <main class="site-main">
            <article>
              <header class="entry-header">
                <a href="/2013/04/18/build-nodejs-mysql-libmysqlclient-on-windows/">
                  <h2 class="entry-title">nodejs mysql-libmysqlclient on windows</h2>
                </a><span class="posted-on"><time datetime="2013-04-18T10:45:26.000Z">Thursday, April 18, 2013 6:45 PM</time></span></header>
              <div class="entry-content">当前使用node-mysql-libmysqlclient的版本为1.5.2 虽然作者曾表示要支持Windows，但是已经很久没有动静了…… 由于笔者在Windows、Linux、MacOSX上都有开发环境，所以不得不让他们都支持…… 废话不多说，开始动手。 由于这个node-mysql-libmysqlclient编译的有个依赖库，我们先安装一下node-gyp [code]npm install node-gyp -gd[/code] 之后装mysql-libmysqlclient，我们不直接用npm，我们找到node_modules目录，git
                clone一下 [code]git clone git://github.com/Sannis/node-mysql-libmysqlclient.git[/code] 然后把 node-mysql-libmysqlclient 目录的名字改成 mysql-libmysqlclient [code] cd mysql-libmysqlclient node-gyp rebuild [/code] 然后我们大概能看到如下的错误消息 [code] gyp info it
                worked if it ends with ok gyp info using node-gyp@0.9.5 gyp info using node@0.10.4 | win32 | ia32 gyp info spawn python gyp info spawn args [ 'D:\\Users\\TengAttack\\AppData\\Roaming\\npm\\node_module s\\node-gyp\\gyp\\gyp', gyp info spawn
                args 'binding.gyp', gyp info spawn args '-f', gyp info spawn args 'msvs', gyp info spawn args '-G', gyp info spawn args 'msvs_version=auto', gyp info spawn args '-I', gyp info spawn args 'D:\\Users\\TengAttack\\AppData\\Roaming\\npm\\node_module
                s\\mysql-libmysqlclient\\build\\config.gypi', gyp info spawn args '-I', gyp info spawn args 'D:\\Users\\TengAttack\\AppData\\Roaming\\npm\\node_module s\\node-gyp\\addon.gypi', gyp info spawn args '-I', gyp info spawn args 'D:\\Users\\TengAttack\\.node-gyp\\0.10.4\\common.gypi',
                gyp info spawn args '-Dlibrary=shared_library', gyp info spawn args '-Dvisibility=default', gyp info spawn args '-Dnode_root_dir=D:\\Users\\TengAttack\\.node-gyp\\0.10.4' , gyp info spawn args '-Dmodule_root_dir=D:\\Users\\TengAttack\\AppData\\Roaming
                \\npm\\node_modules\\mysql-libmysqlclient', gyp info spawn args '--depth=.', gyp info spawn args '--generator-output', gyp info spawn args 'D:\\Users\\TengAttack\\AppData\\Roaming\\npm\\node_module s\\mysql-libmysqlclient\\build', gyp
                info spawn args '-Goutput_dir=.' ] gyp info spawn C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe gyp info spawn args [ 'build/binding.sln', gyp info spawn args '/clp:Verbosity=minimal', gyp info spawn args '/nologo', gyp info
                spawn args '/p:Configuration=Release;Platform=Win32' ] 在此解决方案中一次生成一个项目。若要启用并行生成，请添加“/m”开关。 mysql_bindings_connection.cc mysql_bindings_statement.cc mysql_bindings_result.cc mysql_bindings.cc d:\users\tengattack\appdata\roaming\npm\node_modules\mysql-libmysqlclient\src\.
                /mysql_bindings_connection.h(11): fatal error C1083: 无法打开包括文件:“mysql.h ”: No suc h file or directory [D:\Users\TengAttack\AppData\Roaming\npm\node_modules\mysql -libmysqlclient\build\mysql_bindings.vcxproj] d:\users\tengattack\appdata\roaming\npm\node_modules\mysql-libmysqlclient\src\.
                /mysql_bindings_connection.h(11): fatal error C1083: 无法打开包括文件:“mysql.h ”: No suc h file or directory [D:\Users\TengAttack\AppData\Roaming\npm\node_modules\mysql -libmysqlclient\build\mysql_bindings.vcxproj] d:\users\tengattack\appdata\roaming\npm\node_modules\mysql-libmysqlclient\src\.
                /mysql_bindings_connection.h(11): fatal error C1083: 无法打开包括文件:“mysql.h ”: No suc h file or directory [D:\Users\TengAttack\AppData\Roaming\npm\node_modules\mysql -libmysqlclient\build\mysql_bindings.vcxproj] d:\users\tengattack\appdata\roaming\npm\node_modules\mysql-libmysqlclient\src\.
                /mysql_bindings_connection.h(11): fatal error C1083: 无法打开包括文件:“mysql.h ”: No suc h file or directory [D:\Users\TengAttack\AppData\Roaming\npm\node_modules\mysql -libmysqlclient\build\mysql_bindings.vcxproj] gyp ERR! build error gyp ERR!
                stack Error: `C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe ` failed with exit code: 1 gyp ERR! stack at ChildProcess.onExit (D:\Users\TengAttack\AppData\Roaming\n pm\node_modules\node-gyp\lib\build.js:267:23) gyp ERR! stack
                at ChildProcess.EventEmitter.emit (events.js:98:17) gyp ERR! stack at Process.ChildProcess._handle.onexit (child_process.js:784: 12) gyp ERR! System Windows_NT 6.2.9200 gyp ERR! command &quot;node&quot; &quot;D:\\Users\\TengAttack\\AppData\\Roaming\\npm\\node_modu
                les\\node-gyp\\bin\\node-gyp.js&quot; &quot;rebuild&quot; gyp ERR! cwd D:\Users\TengAttack\AppData\Roaming\npm\node_modules\mysql-libmysql client gyp ERR! node -v v0.10.4 gyp ERR! node-gyp -v v0.9.5 gyp ERR! not ok [/code] 这时我们进入目录 mysql-libmysqlclient\build
                下，会发现有个叫做 binding.sln 的VS项目文件，用VS打开，选Release模式。 然后我们在项目选项中添加上mysql的include目录和lib目录，这里需要注意我们的node在官网上下的安装包是x86的，所以我们的mysql的lib也需要是x86的（这个和你运行的MySQL的位数不一定要相同），从官网上下一个zip包就好了。 之后就是在选项里链接器中加入libmysql.lib和mysqlclient.lib。 接着就是需要改一些代码，来适应VS的编译器，大概修改和添加的代码如下:
                pthread-win.cc [code lang=&quot;cpp&quot;] #include &quot;pthread-win.h&quot; int pthread_mutex_init(pthread_mutex_t *mutex, const void *attr) { *mutex = CreateMutex( NULL, // default security attributes FALSE, // initially not owned NULL);
                // unnamed mutex return 0; } int pthread_mutex_lock(pthread_mutex_t *mutex) { WaitForSingleObject(*mutex, INFINITE); return 0; } int pthread_mutex_unlock(pthread_mutex_t *mutex) { ReleaseMutex(*mutex); return 0; } int pthread_mutex_destroy(pthread_mutex_t
                *mutex) { CloseHandle(*mutex); return 0; } [/code] pthread-win.h [code lang=&quot;cpp&quot;] #ifndef _PTHREAD_WIN_H_ #define _PTHREAD_WIN_H_ #include &lt;windows.h&gt; typedef HANDLE pthread_mutex_t; int pthread_mutex_init(pthread_mutex_t
                *mutex, const void *attr); int pthread_mutex_lock(pthread_mutex_t *mutex); int pthread_mutex_unlock(pthread_mutex_t *mutex); int pthread_mutex_destroy(pthread_mutex_t *mutex); #endif [/code] 把 mysql_bindings_connection.h [code lang=&quot;cpp&quot;]
                #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; [/code] 改成 [code lang=&quot;cpp&quot;] #ifndef WIN32 #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #else #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt;
                #include &lt;ctime&gt; #include &quot;pthread-win.h&quot; #undef errno #define snprintf _snprintf #define strtok_r strtok_s #define gmtime_r(timep, result) gmtime_s(result, timep) #endif [/code] 把 mysql_bindings_statement.cc [code lang=&quot;cpp&quot;]
                unsigned long length[field_count]; my_bool is_null[field_count]; // actual binded buffers void** buffers; buffers = (void **) malloc(field_count * sizeof(void *)); MYSQL_BIND bind[field_count]; [/code] 改成 [code lang=&quot;cpp&quot;] //
                actual binded buffers void** buffers; buffers = (void **) malloc(field_count * sizeof(void *)); #ifndef WIN32 unsigned long length[field_count]; my_bool is_null[field_count]; MYSQL_BIND bind[field_count]; memset(bind, 0, sizeof(bind));
                #define _FREE_ALLOC() #else unsigned long *length = (unsigned long *)malloc(field_count * sizeof(unsigned long)); my_bool *is_null = (my_bool *)malloc(field_count * sizeof(my_bool)); MYSQL_BIND *bind = (MYSQL_BIND *)malloc(field_count
                * sizeof(MYSQL_BIND)); #define _FREE_ALLOC() { free(length); free(is_null); free(bind); } #endif [/code] 并在<strong>该函数</strong>后面的每一个（一共有 4 处） [code lang=&quot;cpp&quot;] return scope.Close( ... [/code] 前面加上一行 [code lang=&quot;cpp&quot;]
                _FREE_ALLOC(); [/code] 注意还有个地方可能需要改的就是在 mysql 的 include 的一个文件 mysql_com.h，他可能会报错，关于my_socket类型的一个问题，我们在 [code lang=&quot;cpp&quot;] #ifndef _mysql_com_h #define _mysql_com_h [/code] 之后加上如下代码即可: [code lang=&quot;cpp&quot;] #ifdef WIN32
                #undef my_socket #define my_socket int #endif [/code] 然后就是编译，编译完成后 Release 目录下就会有个 mysql_bindings.node 文件(DLL)，这时我们还需要把链接的 libmysql.lib 对应的 libmysql.dll 文件也放到这个目录下就可以了。 如果是在一个其他的工作目录中也需要用到 mysql-libmysqlclient ，我们只需要先在 node_modules 目录下
                git 之后，改目录名，去掉前面的 <strong>node-</strong> ，然后把现在的 build 目录下的 Release 目录拷到那个工作目录下 node_modules/mysql-libmysql/build 目录下就可以了。 Windows下使用也一样很棒！ 这里有编译好的程序(VS2012) <a href="http://tengattack.com/wp-content/uploads/2013/04/mysql_bindings.node-win.7z">mysql_bindings.node-win</a>                （等有空再详细整理一下 </div>
            </article>
          </main>
          <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
              var disqus_config = function () {
                this.page.url = "http://blog.tengattack.com/2013/04/18/build-nodejs-mysql-libmysqlclient-on-windows/";
                this.page.identifier = "build-nodejs-mysql-libmysqlclient-on-windows";
              };
              (function () {
                var d = document,
                  s = d.createElement('script');
                s.src = 'https://tengattack.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
              })();
            </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
        </div>
        <aside class="sidebar">
          <section class="widget">
            <h2 class="widget-title">Tags</h2>
            <ul>
              <li>未分类</li>
              <li>链接表</li>
              <li>galgame</li>
              <li>nginx</li>
              <li>php</li>
              <li>psp</li>
              <li>生活</li>
              <li>web</li>
              <li>梦</li>
              <li>nodejs</li>
              <li>c++</li>
              <li>日本</li>
              <li>Windows</li>
              <li>嵌入式</li>
              <li>友链</li>
              <li>FreeBSD</li>
              <li>SSD</li>
              <li>blog</li>
              <li>device</li>
              <li>google</li>
              <li>汉化</li>
              <li>学校</li>
              <li>develop</li>
              <li>MySQL</li>
              <li>OS</li>
              <li>MacOSX</li>
              <li>生活</li>
              <li>python</li>
              <li>nixie</li>
              <li>RaspberryPi</li>
              <li>PCB</li>
            </ul>
            <h2 class="widget-title">Links</h2>
            <ul>
              <li><a target="_blank" href="http://blog.phoenixlzx.com/">Phoenix's island</a></li>
              <li><a target="_blank" href="http://blog.xwenzi.com/">孑孓的水洼</a></li>
              <li><a target="_blank" href="https://takedakinji.phpfogapp.com/" title="竹田伊織的blog">Insignificantia.</a></li>
              <li><a target="_blank" href="http://vanthic.me/" title="Vanthic Noel's blog">寒凪の城</a></li>
              <li><a target="_blank" href="http://yushiyao.me/" title="Shiyao的博客">Shiyao's blog</a></li>
              <li><a target="_blank" href="http://sukey.tk/" title="苏绮的博客">初夏</a></li>
              <li><a target="_blank" href="http://legendt.me/" title="Legend Tang's blog">伝説の所</a></li>
              <li><a target="_blank" href="http://www.2333333.tk/" title="Fotile Huang's blog">MODULE 1e9+7</a></li>
              <li><a target="_blank" href="http://lightnovel.me/" title="acg 轻小说吐槽日志">轻研社</a></li>
              <li><a target="_blank" href="http://im.dimpurr.com/">钉子の次元</a></li>
            </ul>
          </section>
        </aside>
      </div>
    </div>
  </div>
</body>
</html>