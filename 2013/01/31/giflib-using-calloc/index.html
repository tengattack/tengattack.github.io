<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>giflib居然使用calloc！ - tengattack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="generator" content="hanejs" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="alternate" href="/atom.xml" type="application/atom+xml" title="tengattack ATOM Feed" />
  <link rel="search" href="http://blog.tengattack.com/atom.xml" type="application/opensearchdescription+xml" title="tengattack" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
</head>
<body>
  <div class="site">
    <div class="site-inner">
      <header class="site-header">
        <div class="site-header-main">
          <div class="site-branding">
            <a href="/" title="tengattack">
              <h1 class="site-title">tengattack</h1>
            </a>
          </div>
        </div>
      </header>
      <div class="site-content">
        <div class="content-area">
          <main class="site-main">
            <article>
              <header class="entry-header">
                <a href="/2013/01/31/giflib-using-calloc/">
                  <h2 class="entry-title">giflib居然使用calloc！</h2>
                </a><span class="posted-on"><time datetime="2013-01-30T18:53:07.000Z">Thursday, January 31, 2013 2:53 AM</time></span></header>
              <div class="entry-content">今天想为gif图片提供支持，找到了现成的gif库giflib: <a href="http://sourceforge.net/projects/giflib/">http://sourceforge.net/projects/giflib/</a> 由于是在Windows下开发，使用了VS2012，由于VS不支持C99标准(没有 stdbool.h 文件)，giflib的c文件中使用bool会提示未知类型，不过这些都是小问题，很容易就可以通过修改部分代码改掉，从而成功编译，这里就不细谈了。
                由于是VS，一般我们都会在Debug中调试程序，不过很不幸，在读取一张gif图片的时候居然发生了内存错误:
                <a href="/uploads/2013/01/neko.gif"><img class="/uploads/2013/01/neko.gif" alt width="500" height="250" /></a> <strong>一张很萌的gif的说~</strong> 通过仔细调试，发现错误是由于GifFreeMapObject函数对ColorMapObject类型中的(GifColorType)Colors的free造成的。 很奇怪，为什么free会出错？难道是写入数据越界了吗？ 又仔细翻了一下代码，发现并没有这种情况，giflib开发者想必也不会让这种情况发生吧，哪到底是什么问题呢？
                我们找到GifMakeMapObject函数，发现他对Colors的分配是使用了calloc这个函数: [code lang=&quot;cpp&quot;] Object-&gt;Colors = (GifColorType *)calloc(ColorCount, sizeof(GifColorType)); [/code] 这时就隐约感觉发现问题所在了，立刻改成: [code lang=&quot;cpp&quot;] Object-&gt;Colors =
                (GifColorType *)malloc(ColorCount * sizeof(GifColorType)); if (ColorMap == NULL) memset((char *)Object-&gt;Colors, 0, ColorCount * sizeof(GifColorType)); [/code] <strong>由于calloc会初始化分配好的内存，所以我们也应该用memset初始化一下。</strong> 而这里对ColorMap进行判断是，是因为后面有这样一段代码:
                [code lang=&quot;cpp&quot;] if (ColorMap != NULL) { memcpy((char *)Object-&gt;Colors, (char *)ColorMap, ColorCount * sizeof(GifColorType)); } [/code] 本着不重复写内存的原则，本人加了一个判断，看是否需要初始化这块分配好的内存。 <span style="color: #ccffcc;"><strong><del datetime="2013-04-05T08:34:39+00:00">众所周知，calloc是使用栈空间的，而很可怕的是由于各种原因本人程序在DEBUG下栈空间很紧张，这一用calloc分配就导致了各种奇葩的问题，改成用malloc之后程序果断没有问题了。</del></strong></span>                不好意思，前面写错了，calloc并不是分配的是栈空间，感谢AngryCat告知 <a href="http://msdn.microsoft.com/en-us/library/aa272048(v=vs.60).aspx">http://msdn.microsoft.com/en-us/library/aa272048(v=vs.60).aspx</a> 我猜想的原因还是由于是在Debug模式下的一些函数的原因，在Debug模式下调用calloc会调用_calloc_dbg函数：
                <a href="http://msdn.microsoft.com/en-us/library/9tkcfd07(v=vs.80).aspx">http://msdn.microsoft.com/en-us/library/9tkcfd07(v=vs.80).aspx</a> 然后可能就发生了点奇葩的现象…… 不过使用calloc真是蛋疼啊！ PS. 如果不是DEBUG模式，本人的程序在这里使用calloc就没有问题</div>
            </article>
          </main>
          <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
              var disqus_config = function () {
                this.page.url = "http://blog.tengattack.com/2013/01/31/giflib-using-calloc/";
                this.page.identifier = "giflib-using-calloc";
              };
              (function () {
                var d = document,
                  s = d.createElement('script');
                s.src = 'https://tengattack.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
              })();
            </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
        </div>
        <aside class="sidebar">
          <section class="widget">
            <h2 class="widget-title">Tags</h2>
            <ul>
              <li>未分类</li>
              <li>链接表</li>
              <li>galgame</li>
              <li>nginx</li>
              <li>php</li>
              <li>psp</li>
              <li>生活</li>
              <li>web</li>
              <li>梦</li>
              <li>nodejs</li>
              <li>c++</li>
              <li>日本</li>
              <li>Windows</li>
              <li>嵌入式</li>
              <li>友链</li>
              <li>FreeBSD</li>
              <li>SSD</li>
              <li>blog</li>
              <li>device</li>
              <li>google</li>
              <li>汉化</li>
              <li>学校</li>
              <li>develop</li>
              <li>MySQL</li>
              <li>OS</li>
              <li>MacOSX</li>
              <li>生活</li>
              <li>python</li>
              <li>nixie</li>
              <li>RaspberryPi</li>
              <li>PCB</li>
            </ul>
          </section>
        </aside>
      </div>
    </div>
  </div>
</body>
</html>